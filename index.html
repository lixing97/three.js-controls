<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js-controls</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				margin: 0px;
				color: #fff;
				font-family:Monospace;
				overflow: hidden;
			}
			#info {
				font-size: 11px;
				line-height: 18px;
				position: absolute;
				padding: 15px;
				pointer-events: none;
			}
			#info a {
				color: white;
				display: inline-block;
				text-decoration: none;
				pointer-events: all;
			}
			a::first-letter {
				color: #0f9;
				font-size: 15px;
				font-weight: bold;
				text-shadow: 1px 1px 2px black;
				letter-spacing: 0.1em;
			}
			canvas {
				width: 100% !important;
				height: 100% !important;
				image-rendering: pixelated;
			}
			io-inspector {
				position: absolute;
				top: 0;
				right: 0;
			}
		</style>
	</head>
	<body>

		<div id="info">
			<span>Transform:</span>
			<a href="javascript:setupTransformControls('TranslateTransformControls')">W translate</a> |
			<a href="javascript:setupTransformControls('RotateTransformControls')">E rotate</a> |
			<a href="javascript:setupTransformControls('ScaleTransformControls')">R scale</a> |
			<a href="javascript:setupTransformControls('CombinedTransformControls')">T combined </a> |
			<a href="javascript:setupTransformControls('StretchTransformControls')">Y stretch (WIP) </a><br />
			<span>Viewport controls:</span>
			<a href="javascript:setupCameraControls('OrbitCameraControls')">1 orbit</a> |
			<a href="javascript:setupCameraControls('EditorCameraControls')">2 editor</a> |
			<a href="javascript:setupCameraControls('TrackballCameraControls')">3 trackball</a><br />
			<!-- <a href="javascript:setupCameraControls('FirstPersonControls')">4 first person</a> | -->
			<!-- <a href="javascript:setupCameraControls('FlyControls')">3 fly</a><br /> -->
			<span>Toggle:</span>
			<a href="javascript:toggle('space')">Q world/local space</a> |
			<a href="javascript:toggle('X')">X</a> |
			<a href="javascript:toggle('Y')">Y</a> |
			<a href="javascript:toggle('Z')">Z toggle axis</a><br />
			<span>click - select |</span>
			<span>click + Ctrl - multi-select</span>
			<!-- <a>Shift marquee/add</a> | -->
			<!-- <a>Alt snap</a> -->
		</div>

		<script type="module">

			import {DragTransformControls} from "./src/controls/transform/Drag.js";
			import {TranslateTransformControls} from "./src/controls/transform/Translate.js";
			import {RotateTransformControls} from "./src/controls/transform/Rotate.js";
			import {ScaleTransformControls} from "./src/controls/transform/Scale.js";
			import {StretchTransformControls} from "./src/controls/transform/Stretch.js";
			import {CombinedTransformControls} from "./src/controls/transform/Combined.js";

			import {CameraControls} from "./src/controls/Camera.js";
			import {EditorCameraControls} from "./src/controls/camera/Editor.js";
			import {OrbitCameraControls} from "./src/controls/camera/Orbit.js";
			import {TrackballCameraControls} from "./src/controls/camera/Trackball.js";

			import {SelectionControls} from "./src/controls/Selection.js";

			import {TransformHelperTranslate} from "./src/helpers/transform/Translate.js";

			import {WebGLRenderer, PerspectiveCamera, OrthographicCamera, Scene, GridHelper, HemisphereLight,
				BoxBufferGeometry, MeshLambertMaterial, Mesh, Object3D, TextureLoader, Color,
				SphereBufferGeometry, Vector3,BufferGeometry, BufferAttribute} from "./lib/three.module.js";

			import {GLTFLoader} from "./examples/GLTFLoader.js";

			import {IoInspector} from "./lib/io-inspector-standalone.js";

			let rendered = false;
			let renderer, camera, scene, helperScene;
			var transformControls;
			var viewportControls;
			var selectionControls;

			let inspector = new IoInspector({expanded: true});
			// inspector.config = {
			// 	'Object': {
			// 		'key:position': {tag: 'io-object', config: {expanded: true}},
			// 		'key:quaternion': {tag: 'io-object', config: {expanded: true}},
			// 		'key:rotation': {tag: 'io-object', config: {expanded: true, config: {
			// 			'Object': {
			// 				'type:number': {tag: 'io-number', config: {conversion: 180 / Math.PI}},
			// 			}
			// 		}}},
			// 		'key:scale': {tag: 'io-object', config: {expanded: true}},
			// 		'key:renderOrder': {tag: 'io-number', config: {step: 0.1}},
			// 	},
			// 	groups: []
			// }
			window.addEventListener('io-object-mutated', render);

			scene = new Scene();
			helperScene = new Scene();

			var loader = new GLTFLoader();
			loader.load( 'examples/cubes.gltf', function ( gltf ) {

				gltf.scene.scale.multiplyScalar(1000);

				scene.add( gltf.scene );

				selectionControls.toggle(gltf.scene.children[0].children[0]);

				render();

			}, undefined, function ( e ) {

				console.error( e );

			} );

			init();
			render();

			function init() {

				renderer = new WebGLRenderer({ antialias: true });
				renderer.autoClear = false;
				renderer.gammaOutput = true;
				renderer.setClearColor(0x666666);
				renderer.domElement.setAttribute('tabindex', 0);

				document.body.appendChild(renderer.domElement);
				document.body.appendChild(inspector);

				camera = new PerspectiveCamera(30, window.innerWidth / window.innerHeight, 100, 1000000);
				let a = window.innerWidth / innerHeight, s = 1800;
				camera = new OrthographicCamera(-s * a, s * a, s, -s, 0, 55000);
				camera.position.set(4000, 2000, 4000);
				camera.lookAt(0, 500, 0);

				onWindowResize();

				var grid = new GridHelper(1000, 10);
				scene.add(grid);

				var light = new HemisphereLight(0x333333, 0xffffff, 3);
				scene.add(light);

				// for (var i = 0; i < 6; i++) {
				// 	for (var j = 0; j < 6; j++) {
				// 		for (var k = 0; k < 6; k++) {
				// 			const obj3d = new Object3D();
				// 			obj3d.position.set(i * 200 - 500, k * 200 - 500, j * 200 - 500);
				// 			helperScene.add(obj3d);
				// 			// const control = new TranslateTransformControls({domElement: renderer.domElement, camera: camera});
				// 			const control = new TransformHelperTranslate();
				// 			control.size = 0.05;
				// 			control.addEventListener('change', transformControlsChanged);
				// 			control.object = obj3d;
				// 			helperScene.add(control);
				// 		}
				// 	}
				// }

				selectionControls = new SelectionControls({domElement: renderer.domElement, camera: camera, object_: scene});
				helperScene.add(selectionControls);
				selectionControls.addEventListener('change', render);
				selectionControls.addEventListener('selected-changed', event => {
					// transformControls.object = event.detail.selected.length ? selectionControls : null;
					// TODO: test with individual objects
					// console.log(event.detail.selected)
					transformControls.object = event.detail.selected.length ? event.detail.selected[0] : null;
					inspector.value = transformControls.object || {};
					transformControls.objectChanged();
					transformControls.enabled = true;
				});

				setupCameraControls('EditorCameraControls');
				setupTransformControls('RotateTransformControls');

				scene.updateMatrixWorld();

				// TODO: figure out how to better pass resolution to materials.
				{
					let res = new Vector3(Math.round(window.innerWidth / window.scale), Math.round(window.innerHeight / window.scale), window.devicePixelRatio);
					helperScene.traverse(child => {
						if (child.material) child.material.resolution = res;
					})
				}

				function setupCameraControls(controlName) {
					let ControlClass = EditorCameraControls;
					if (controlName === 'OrbitCameraControls') ControlClass = OrbitCameraControls;
					if (controlName === 'EditorCameraControls') ControlClass = EditorCameraControls;
					if (controlName === 'TrackballCameraControls') ControlClass = TrackballCameraControls;


					if (viewportControls) {
						viewportControls.dispose();
					}
					viewportControls = new ControlClass({domElement: renderer.domElement, camera: camera});
					viewportControls.target.set(0, 500, 0);
					// viewportControls.autoOrbit.set(0.002, 0);
					viewportControls.addEventListener('active-changed', viewportControlsChanged);
				}
				window.setupCameraControls = setupCameraControls;

				function viewportControlsChanged(event) {
					transformControls.enabled = event.detail.value ? false : true && !!selectionControls.selected.length;
					render();
				}

				function setupTransformControls(controlName) {
					let ControlClass = TranslateTransformControls;
					if (controlName === 'TranslateTransformControls') ControlClass = TranslateTransformControls;
					if (controlName === 'RotateTransformControls') ControlClass = RotateTransformControls;
					if (controlName === 'ScaleTransformControls') ControlClass = ScaleTransformControls;
					if (controlName === 'StretchTransformControls') ControlClass = StretchTransformControls;
					if (controlName === 'CombinedTransformControls') ControlClass = CombinedTransformControls;
					if (controlName === 'DragTransformControls') ControlClass = DragTransformControls;

					let space = 'local';

					if (transformControls) {
						space = transformControls.space;
						transformControls.dispose();
						helperScene.remove(transformControls);
					}
					if (selectionControls) selectionControls.enabled = true;
					if (viewportControls) viewportControls.enabled = true;
					transformControls = new ControlClass({domElement: renderer.domElement, camera: camera});
					transformControls.addEventListener('change', render);
					transformControls.addEventListener('active-changed', transformControlsChanged);
					transformControls.addEventListener('space-changed', transformControlsChanged);
					transformControls.addEventListener('axis-changed', transformControlsChanged);
					transformControls.object = transformControls.object = selectionControls && selectionControls.selected.length ? selectionControls : null;
					transformControls.space = space;
					helperScene.add(transformControls);
				}
				window.setupTransformControls = setupTransformControls;

				function transformControlsChanged(event) {
					if (event.detail.property === 'active') viewportControls.enabled = event.detail.value ? false : true;
					if (event.detail.property === 'space') selectionControls.transformSpace = event.detail.value;
					if (event.detail.property === 'axis') {
						selectionControls.enabled = event.detail.value ? false : true;
						viewportControls.enabled = event.detail.value ? false : true;
					}
				}

				function toggle(axis) {
					if (axis === "X") transformControls.showX = !transformControls.showX;
					if (axis === "Y") transformControls.showY = !transformControls.showY;
					if (axis === "Z") transformControls.showZ = !transformControls.showZ;
					if (axis === "space" && !transformControls.active) {
						transformControls.space = transformControls.space === "local" ? "world" : "local";
					}
				}
				window.toggle = toggle;

				window.addEventListener( 'keydown', function ( event ) {
					switch ( event.keyCode ) {
						case 87: // W
							setupTransformControls('TranslateTransformControls');
							break;
						case 69: // E
							setupTransformControls('RotateTransformControls');
							break;
						case 82: // R
							setupTransformControls('ScaleTransformControls');
							break;
						case 84: // T
							setupTransformControls('CombinedTransformControls');
							break;
						case 89: // Y
						setupTransformControls('StretchTransformControls');
							break;
						case 49: // 1
							setupCameraControls('OrbitCameraControls');
							break;
						case 50: // 2
							setupCameraControls('EditorCameraControls');
							break;
						case 51: // 3
							setupCameraControls('TrackballCameraControls');
							break;
						case 52: // 4
							setupCameraControls(FirstPersonControls);
							break;
						case 53: // 5
							setupCameraControls(FlyControls);
							break;
						case 81: // Q
							toggle('space');
							break;
						case 187:
						case 107: // +, =, num+
							transformControls.size = transformControls.size * 1.1;
							break;
						case 189:
						case 109: // -, _, num-
							transformControls.size = Math.max( transformControls.size * 0.9, 0.01 );
							break;
						case 88: // X
							toggle('X');
							break;
						case 89: // Y
							toggle('Y');
							break;
						case 90: // Z
							toggle('Z');
							break;
					}
				});
			}

			window.addEventListener('resize', onWindowResize, false);

			function onWindowResize() {
				renderer.setSize(window.innerWidth, window.innerHeight);
				renderer.setPixelRatio(window.devicePixelRatio);
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				render();
			}

			function animate() {
				requestAnimationFrame(animate);
				rendered = false;
			}

			function render() {
				if (rendered) return;
				rendered = true;
				renderer.clear();
				renderer.render(scene, camera);
				renderer.clearDepth();
				renderer.render(helperScene, camera);
			}

			animate();
			render();

		</script>

	</body>
</html>
